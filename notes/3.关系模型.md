# 第三章 关系模型

## 关系基本概念

###  关系模型的诞生

E.F.Codd于70年代初提出关系数据理论，他因此获得1981年的ACM图灵奖关系理论建立在集合代数理论基础之上，有着坚实的数学基础

早期代表系统
System K：由IBM研制
INGRES：由加州Berkeley分校研制

目前主流的商业数据库系统
Oracle, SQL Server, DB2
MySQL, PostgreSQL
OceanBase, GaussDB, 达梦
Access, SQLite

### 笛卡尔积 (Car'tesian Product)

域 (Domain)：具有相同数据类型的一组值的集合，如整数集合、宇符串集合、全体学生集合

一组域$D_1,D_2,...,D_n$的笛卡尔积为：

$$
D_1\times D_2\times\cdots\times D_n=\{(d_1,d_2,...,d_n)\mid d_i\in D_i,i=1,...,n\}
$$
n元组(tuple)：笛卡尔积的元素$(d_1,d_2,...,d_n)$ 

分量 (component)：元组的每一个值 di

苗卡尔积的基数：若 $D_i$ 的基数为 $m_i$ , $\prod_{i=1}^nm_i$

#### 苗卡尔积：可能的世界

老师集合T
学生集合S
课程集合C

TSC是个三元组集合，元组个数 2×3×2
它是所有可能的（老师，学生，课程）元组集合

笛卡尔积可表为二维表的形式：

<img src="./3.关系模型.assets/CleanShot 2024-03-11 at 21.37.41@2x.png" alt="CleanShot 2024-03-11 at 21.37.41@2x" style="zoom:50%;" />

### 关系：笛卡尔积的子集

笛卡尔积$D_1\times D_2\times\cdots\times D_n$的子集称作在域$D_1,D_2,...,D_n$上的关系，用$R(D_1,D_2,...,D_n)$表示， $R$是关系的名字，$n$是关系的度或目

关系是笛卡尔积中有意义的子集

1. 关系名体现了现实实体或联系
2. 关系集合包含了真正存在的实体或发生的联系

#### 过江之鲫：关系实例的数目

$$
{\mathrm{D1:=\{A,B,C,D,E\}}}\\
\mathrm{D}2:=\{1,2,3,4\}\\
D3:=\{甲，乙，丙，丁\}
$$
 D1×D2×D3包含多少个关系？$2^{80} $ 

 $\{\mathcal{A},\mathcal{B},\mathcal{C},\mathcal{D},\mathcal{E},1,2,3,4,甲，乙，丙，丁\}$​
 划分为多少个域，每个域多少个元素， 使得笛卡尔积包含的关系数目最多？原则是一个域3个元素，最后剩下的拆成2，答案是 {3, 3, 3, 2, 2}，如果是连续的，那就是 e

#### 关系的性质

P1：列是同质的，是同一类型的数据，即每一列中的分量来自同一域

不同质违反了关系对实体联系的表达，以及对实体属性的刻画：

<img src="./3.关系模型.assets/CleanShot 2024-03-11 at 21.53.45@2x.png" alt="CleanShot 2024-03-11 at 21.53.45@2x" style="zoom:50%;" />

P2：不同的列可以来自同一域，每列必须有不同的属性名

什么时候两个列会来自同一个域？一元联系、类型相同的属性

<img src="./3.关系模型.assets/CleanShot 2024-03-11 at 21.54.33@2x.png" alt="CleanShot 2024-03-11 at 21.54.33@2x" style="zoom:30%;" />

Р3：行列的顺序无关紧要

P4：任意两个元组不能完全相同（集合内不能有相同的两个元素）

P5：每一分量必须是不可再分的数据，称其为作满足第一范式（INF）的关系

嵌套关系：

<img src="./3.关系模型.assets/CleanShot 2024-03-11 at 21.55.34@2x.png" alt="CleanShot 2024-03-11 at 21.55.34@2x" style="zoom:30%;" />

1NF关系：

<img src="./3.关系模型.assets/CleanShot 2024-03-11 at 21.55.42@2x.png" alt="CleanShot 2024-03-11 at 21.55.42@2x" style="zoom:30%;" />

以查询的角度，深入分析嵌套关系的利弊： 声明性查询 VS 路径式查询，**<u>嵌套关系不能反向查询</u>**

## 关系模型三要素

### 数据结构

单一的数据结构— 关系，实体集、联系都表示成关系

思考：单一数据结构带来的好处是什么？数据结构单纯，都是表，处理简单

<img src="./3.关系模型.assets/CleanShot 2024-03-11 at 22.10.12@2x.png" alt="CleanShot 2024-03-11 at 22.10.12@2x" style="zoom:40%;" />

<img src="./3.关系模型.assets/CleanShot 2024-03-11 at 22.11.47@2x.png" alt="CleanShot 2024-03-11 at 22.11.47@2x" style="zoom:40%;" />

#### 码

候选码（Candidate Key）：关系中的一个属性组，其值能唯一标识一个元组若从属性组中去掉任何一个属性，它就不具有这一性质了，这样的属性组称作候选码（如DEPT中的dno，dname都可作为候选码）

主属性：任何一个候选码中的属性（如SC中的sno，cno， DEPT中的dno，dname）

主码（PK，Primary Key）：进行数据库设计时，从一个关系的多个候选码中选定一个作为主码（如可选定dno作DEPT的主码）

外码 (FK，Foreign Key)：关系R中的一个属性组，它不是R的码，但它与另一个关系S的码相对应，称这个属性组为R的外码（如S关系中的dno属性）

#### 关系模式

关系的描述，记作R（A1,A2，...  ，An），包括：关系名、关系中的属性名
属性向域的映象，通常说明为属性的类型、长度等
属性间的数据依赖关系，比如在特定的时间和教室只能安排一门课

关系模式是型，是稳定的

#### 关系：

某一时刻对应某个关系模式的内容（元组的集合）

关系是某一时刻的值，是随时间不断变化的

#### 关系数据库的型

是关系模式的集合，即数据库描述。称作数据库的内涵（Intension）

#### 关系数据库的值

是某一时刻关系的集合。称作数据库的外延（Extension）

### 数据操作

关系操作是集合操作
操作的对象及结果都是集合
是一次一集合（Set-at-a-time）的方式

#### 关系数据语言的特点

都是由于关系操作是基于集合的

一体化：对象单一，都是关系，因此操作符也单一

非过程化：用户只需提出“做什么”，无须说明“怎么做”，存取路径的选择和操作过程由系统自动完成

面向集合的存取方式：操作对象是一个或多个关系，结果是一个新的关系（一次一关系），非关系系统是一次一记录的方式

#### 抽象的关系模型查询语言：

1. 关系代数：用预定义操作算子的执行序列来表达查询
2. 关系验算：用谓词来表达查询，只需描述所需信息的特性
   1. 元组关系验算：谓词变元是元组
   2. 域关系验算：谓词变元是属性列

SQL：介于关系代数和关系演算之间，由IBM公司在研制System R时提出

### 数据完整性

#### 实体完整性

关系的主码中的属性值不能为空值

空值：不知道或无意义

意义：关系对应到现实世界中的实体集，元组对应到实体，实体是相互可区分的，通过主码来唯一标识，若主码为空，则出现不可标识的实体，这是不容许的

<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 00.39.34@2x.png" alt="CleanShot 2024-03-12 at 00.39.34@2x" style="zoom:50%;" />

#### 参照完整性

如果关系$R_{2}$的外码$F_{k}$与关系$R_{1}$的主码$P_{k}$相对应，则$R_{2}$中每个元组的$F_k$值或者等于$R_1$中某个元组的$P_k$值，或者为空值

如果关系$R_{2}$的某个元组$t_{2}$参照了关系$R_1$的某个元组$t_1$, 则$t_{1}$必须存在，也即必须与客观存在的实体发生联系

<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 00.44.21@2x.png" alt="CleanShot 2024-03-12 at 00.44.21@2x" style="zoom:50%;" />

#### 用户定义完整性

用户针对具体应用环境定义的完整性约束条件

1. Sno要求是8位整数，首位是0或1
2. 飞行员的飞行里程与星级评定
3. 选课人数不能少于10人，多于100人
4. 在本地纳税记录超过5年才有购房资格
5. 婚姻登记必须购买百年好合保险……

实体完整性和参照完整性由系统自动支持，系统提供定义和检验用户定义的完整性的机制

#### 课堂练习：关系模型完整性例子

<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 00.51.31@2x.png" alt="CleanShot 2024-03-12 at 00.51.31@2x" style="zoom:50%;" />

只有3、4可以

1：主码不能是空值，违反了实体完整性

2：重复的主码

5：不存在的外码，违反了参照完整性

## 关系代数的运算

### 关系代数运算汇览

<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 00.55.17@2x.png" alt="CleanShot 2024-03-12 at 00.55.17@2x" style="zoom:40%;" />

### 基本关系代数运算

#### 选择运算

在关系中选择满足给定条件的元组（行角度）
$$
\sigma_F(\mathbb{R})=\{t\mid t\in\mathbb{R},F(t)=^{\prime}\text{ 真}^{\prime}\}
$$

$$
\begin{aligned}&F\text{是选择的条件,}\forall t\in R,F(t)\text{要么为真,要么为假}\\
&F\text{由逻辑运算符连接算术表达或而成}\end{aligned}
$$

##### 选择运算计算例子

<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 01.04.13@2x.png" alt="CleanShot 2024-03-12 at 01.04.13@2x" style="zoom:40%;" />

<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 01.04.43@2x.png" alt="CleanShot 2024-03-12 at 01.04.43@2x" style="zoom:30%;" />

##### 用选择远算表达查询

找年龄不小于20的男学生
$$
\begin{aligned}\sigma_{age\geq20\wedge sex=\prime M{\prime}}(S)\\\sigma_{age\geq20}(\sigma_{sex=^{\prime}M^{\prime}}(S))\\\sigma_{sex=^{\prime}M^{\prime}}(\sigma_{age\geq20}(S))\end{aligned}
$$
哪种执行方或更为高效，主要取决于数据分布和索引配置

比如对于年龄有一个索引，那么选择最后一种查询方式，可以更快得缩小查询范围。这就是查询优化器的原理，检查那个执行路径更高效

#### 投影运算

从关系中取若干列组成新的关系（从列的角度）
$$
\prod_A(R)=\{t[A]\mid t\in R\},A\subseteq R
$$
注意：投影的结果中要去掉相同的行

<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 01.06.10@2x.png" alt="CleanShot 2024-03-12 at 01.06.10@2x" style="zoom:30%;" />

##### 投影查询示例

给出所有学生的姓名和年龄：$\prod_{sno,age}(S)$

找001号学生所选修的课程号： $\prod_{cno}(\sigma_{sno=001}(SC))$

#### 更名

将关系R更名为S: $\rho_S(R)$

将计算表达式E更名为关系S: ${\rho_{S(A_1,A_2,...,A_n)}(E)}$

更名运算的必要性：

1. 将更名运算施加到关系上，得到具有不同名字的同一关系
2. 当同一关系多次参与同一运算时需要更名

#### 并运算

所有至少出现在两个关系中之一的元组集合
$$
\mathbb{R}\cup\mathbb{S}=\{r\mid r\in\mathbb{R}\lor r\in \mathbb S\}
$$
<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 01.12.45@2x.png" alt="CleanShot 2024-03-12 at 01.12.45@2x" style="zoom:50%;" />

关系R和S进行并运算的前提是它们必须是相容的

1. 关系R和S必须是同元的，其属性数目必须相同
2. 对∀i，R的第I个属性和S的第I个属性的域必须相同

##### 并运算计算例子

<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 01.13.40@2x.png" alt="CleanShot 2024-03-12 at 01.13.40@2x" style="zoom:30%;" />

##### 并运算查询示例

求选修了001号或002号课程的学生号
$$
\prod_{sno}(\sigma_{cno=001\lor cno=002}(SC))
$$
或者
$$
\prod_{sno}(\sigma_{cno=001}(SC))\cup\prod_{sno}(\sigma_{cno=002}(SC))
$$

#### 差运算

所有出现在一个关系而不在另一关系中的元组集合
$$
R-S=\{r\mid r\in R\land r\notin S\}
$$
<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 01.15.58@2x.png" alt="CleanShot 2024-03-12 at 01.15.58@2x" style="zoom:50%;" />

R和S必须是相容的

##### 差运算计算例子

<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 01.16.15@2x.png" alt="CleanShot 2024-03-12 at 01.16.15@2x" style="zoom:30%;" />

##### 差运算查询示例

求选修了001号但未选修002号课程的学生号
$$
\prod_{sno}(\sigma_{cno=001}(SC))-\prod_{sno}(\sigma_{cno=002}(SC))
$$
注意下面这种写法是错误的， $\sigma$ 下面的条件是对于一行来说的，所以这样就相当于选出来了选了001号课程的同学
$$
\prod_{sno}(\sigma_{\color{red}{cno}=001\wedge cno\neq002}(SC))
$$

#### 集合的交

是扩展运算，不算是关系模型的基础运算

#### 苗卡尔积运算：如何跨表（多行比较）查询？

<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 01.21.24@2x.png" alt="CleanShot 2024-03-12 at 01.21.24@2x" style="zoom:40%;" />

行级思维：逐一扫描SC中的行，过滤出cno=C1的行，获得其sno，再根据得到的sno到S中查找对应的行

什么是集合级思维？运算的对象是集合

如何把多表数据融合到一个表中，以便施加选择和投影运算？

##### 元组的连串 (Concatenation)

$$
\begin{gathered}r=(r_1,\ldots,r_n),\mathrm{~}s=(s_1,\ldots,s_n),\mathrm{~}r\text{与}s\text{的连串定义为}:\\\widehat{\mathrm{rs}}=(\mathrm{r}_1,\ldots,\mathrm{r}_{\mathrm{n}},\mathrm{s}_1,\ldots,\mathrm{s}_{\mathrm{m}})\end{gathered}
$$

##### 关系的苗卡尔积 

$$
R\times S=\{\widehat{rs}\mid r\in R\wedge s\in S\}
$$

R x S的度为R与S的度之和
R x S的元组个数为R和S的元组个数的乘积

##### 笛卡尔积运算示例

<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 01.26.45@2x.png" alt="CleanShot 2024-03-12 at 01.26.45@2x" style="zoom:40%;" />

##### 苗卡尔积运算查询示例

求选修C1课程的学生姓名

<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 01.30.28@2x.png" alt="CleanShot 2024-03-12 at 01.30.28@2x" style="zoom:30%;" />

注意在选择运算时候，两个表的学生编号要相同！！！
$$
\prod_{sname}(\sigma_{S.sno=SC.sno\wedge cno=c1}(S\times SC))
$$

##### 关系自身的笛卡尔积运算

求数学成绩比王红同学高的学生

<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 01.32.17@2x.png" alt="CleanShot 2024-03-12 at 01.32.17@2x" style="zoom:40%;" />
$$
\prod_{S.姓名}\left(\sigma_{R.姓名=王红\ Λ\ R.课程=数学\ Λ\ S.课程=数学\ Λ\ R.成绩<S.成绩}(R\times\rho_S(R))\right)
$$

### 扩展关系代数运算

#### 交运算

所有同时出现在两个关系中的元组集合
$$
R\cap S=\{r\mid r\in R\land r\in S\}
$$
<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 15.20.23@2x.png" alt="CleanShot 2024-03-12 at 15.20.23@2x" style="zoom:50%;" />

交运算可以通过差运算来重写
$$
R\cap S=R-(R-S)
$$

##### 交运算计算例子

<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 15.15.33@2x.png" alt="CleanShot 2024-03-12 at 15.15.33@2x" style="zoom:40%;" />

##### 交运算查询示例

求同时选修了001号和002号课程的学生号

<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 15.16.34@2x.png" alt="CleanShot 2024-03-12 at 15.16.34@2x" style="zoom:50%;" />

#### $\theta$ 连接

从两个关系的广义笛卡儿积中选取给定属性间满足一定条件的元组
$$
{R_{A\theta B}^{{\infty}}S=\{\widehat{rs}\mid r\in R\wedge s\in S\wedge r[A]\theta s[B]\}}
$$
A,B为R和S上度数相等且可比的属性列， $\theta$为算术比较符，为等号时称为等值连接
$$
R_{A\theta B}^{\infty}S=\sigma_{r[A]\theta s[B]}(R\times S)
$$
<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 15.21.06@2x.png" alt="CleanShot 2024-03-12 at 15.21.06@2x" style="zoom:50%;" />

#### 自然连接

从两个关系的广义笛卡儿积中选取在相同属性列B上取值相等的元组，并去掉重复的列
$$
R\rtimes S=\{\widehat{rs}[\overline{B}]\mid r\in R\wedge s\in S\wedge r[B]=S[B]\}
$$
自然连接与等值连接的不同：自然连接中相等的分量必须是相同的属性组，并且要在结果中去掉重复的属性，而等值连接则不必

自然连接为什么非常有用？

##### 自然连接的计算例子

<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 15.24.16@2x.png" alt="CleanShot 2024-03-12 at 15.24.16@2x" style="zoom:50%;" />

##### 自然连接表达查询的例子

求001号学生所在系的名称

<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 15.24.32@2x.png" alt="CleanShot 2024-03-12 at 15.24.32@2x" style="zoom:50%;" />

关系R（A, B），S（A, C），R与S中元组个数分别为10，15，试填写下表

<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 15.29.34@2x.png" alt="CleanShot 2024-03-12 at 15.29.34@2x" style="zoom:50%;" />

##### 自然连接的问题

<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 15.36.38@2x.png" alt="CleanShot 2024-03-12 at 15.36.38@2x" style="zoom:50%;" />

问题：有关P03号职工的姓名和工资信息没有显示出来

##### 如何由关系表生成报表？

<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 15.37.55@2x.png" alt="CleanShot 2024-03-12 at 15.37.55@2x" style="zoom:30%;" />

涉及到多个表之间的连接全能榜？

#### 外连接

为避免自然连接时因失配而发生的信息丢失，可以假定往参与连接的一方表中附加一个取值全力空值的行，它和参与连接的另一方表中的任何一个未匹配上的元组都能匹配，称之为外连接

外连接= 自然连接＋ 未匹配元组（悬挂元组）

外连接的形式：左外连接、右外连接、全外连接

左外连接 =  自然连接 + 左侧表中米匹配元组
右外连接 = 自然连接＋右侧表中未匹配元组
全外连接 = 自然连接＋两侧表中未匹配元组

##### 外连接的执行顺序

<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 15.46.48@2x.png" alt="CleanShot 2024-03-12 at 15.46.48@2x" style="zoom:40%;" />

##### 外连接结合律不成立的反例

<img src="./3.关系模型.assets/CleanShot 2024-03-12 at 15.47.07@2x.png" alt="CleanShot 2024-03-12 at 15.47.07@2x" style="zoom:30%;" />

#### 半连接

