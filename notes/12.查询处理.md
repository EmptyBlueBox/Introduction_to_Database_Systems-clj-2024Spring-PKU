# 第十二章 查询处理

## 查询处理步骤

<img src="./12.查询处理.assets/CleanShot 2024-06-09 at 05.51.09@2x.png" alt="CleanShot 2024-06-09 at 05.51.09@2x" style="zoom:50%;" />

### 查询优化

对一个给定的查询，从多种可能执行方式中选择出最有效率的作为查询执行计划

高效的执行计划有两方面的衡量标准

* 使中间结果最小化
* 采用尽可能好的操作算法

基于代价的方法和启发式方法

### 基于规则的优化示例

<img src="./12.查询处理.assets/CleanShot 2024-06-09 at 05.52.50@2x.png" alt="CleanShot 2024-06-09 at 05.52.50@2x" style="zoom:50%;" />

系统并不执行分组操作, 因为数据库知道没有重复的 col1

### 查询代价

查询处理对各种资源的使用情况

* 磁盘存取（简化为磁盘块传送数）
* CPU时间
* 通信开销

一个重要的影响因素：主存中缓冲区的大小M

* 最好的情形，所有的数据可以读入到缓冲区中
* 最坏的情形，缓冲区只能容纳数目不多的数据块

## 执行计划

考试不要求, 了解即可

## 算子实现

只考虑排序, 别的不要求

### 排序

排序场合

- SQL查询可以指定对输出进行排序
- 关系运算的某些操作，如连接运算，排序后实现高效

对于可放进内存的关系，使用如快排序之类的技术, 对不能放进内存的关系，使用外排序

- 外排序：创建有序段＋N路归并
- 所有的输入数据最初分成许多有序的归并段文件，然后不断归并成许多更大的归并段文件，直到剩下一个文件为止

### 连接运算

三种分别是:

- 循环连接
  - 嵌套循环连接
  - 块嵌套循环连接
  - 索引嵌套循环连接
- 归并连接
- 散列连接

### 嵌套循环连接

<img src="./12.查询处理.assets/CleanShot 2024-06-09 at 05.59.42@2x.png" alt="CleanShot 2024-06-09 at 05.59.42@2x" style="zoom:50%;" />

### 块嵌套循环连接

在外层循环中使用较小的关系代价略小

<img src="./12.查询处理.assets/CleanShot 2024-06-09 at 05.59.55@2x.png" alt="CleanShot 2024-06-09 at 05.59.55@2x" style="zoom:50%;" />

### 索引嵌套循环连接

如果满足下列条件，索引查找可以代替文件扫描

* 是等值连接或自然连接
* 在内关系的连接属性上存在索引

对外关系r的每个元组tr，利用索引查找内关系S的与tr 满足连接条件的元组

### 归并连接

如果不匹配就向下移动较小的那个对应的指针

<img src="./12.查询处理.assets/CleanShot 2024-06-09 at 06.03.14@2x.png" alt="CleanShot 2024-06-09 at 06.03.14@2x" style="zoom:50%;" />

1. 在当前R和S块的前端查找连接属性的最小值
2. 如果这个值在另一个关系的前部没有出现，那么就删除具有这个值的元组
3. 否则，找出两个关系中的这个值的所有的元组，如果需要，从排序的R或者S中读取块，直到不再有其他的元组
4. 进行连接，输出和这个值相关的所有得到的结果元组
5. 如果一个关系在内存中已经没有要考虑的元组了，那么就重新装载为这个关系而设定的缓冲区

### 散列连接

适用于自然连接和等值连接

基本思想

* 将两个关系按连接属性值划分成有相同散列函数值的元组集合
* 关系r在一个散列划分中的元组只需要与关系S在对应的划分中的元组相比较
* 在r和S的每一对划分中进行索引嵌套循环连接（散列索引）

<img src="./12.查询处理.assets/CleanShot 2024-06-09 at 06.05.00@2x.png" alt="CleanShot 2024-06-09 at 06.05.00@2x" style="zoom:50%;" />

小表作为生成哈希的表, 大表作为探测表, 探测跟大表每一项哈希值是否具有相同的小表哈希值, 否则大表可能放不下

### 总结

老师总结:

嵌套循环效率低, 但是适合等值和非等值连接

归并和散列只适合于等值连接

* 如果两个表大小相差大, 散列性能好
* 大小差不多, 性能差不多
* 表上有索引, 归并性能好, 因为不用排序了

Slides 总结:

- 如果一个连接输入很小（比如不到10行），而另一个连接输入很大而且己在其连接列上创建索引，则索引嵌套循环是最快的连接操作
- 如果两个连接输入很大，并已在二者连接列上排序（连接列上有索引），则合并连接是最快的连接操作
- 哈希连接可以处理很大的、未排序的非索引输入
- 如果两个连接输入都很大，而且这两个输入的大小差不多，则预先排序的合并连接提供的性能与哈希连接相似。然而，如果两个输入的大小相差很大，则哈希连接操作通常快得多
- 合并连接和哈希连接只能用于等值连接，对于非等值连接，只能用嵌套循环连接