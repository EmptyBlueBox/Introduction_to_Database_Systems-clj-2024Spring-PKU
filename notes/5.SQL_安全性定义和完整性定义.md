# 第五章 SQL 安全性定义和完整性定义

## 安全性定义

### 角色

角色是一组相关权限的结合，即将多个不同的权限集合在一起就形成了角色

<img src="./5.SQL_安全性定义和完整性定义.assets/CleanShot 2024-06-09 at 06.18.02@2x.png" alt="CleanShot 2024-06-09 at 06.18.02@2x" style="zoom:50%;" />

<img src="./5.SQL_安全性定义和完整性定义.assets/CleanShot 2024-06-09 at 06.18.19@2x.png" alt="CleanShot 2024-06-09 at 06.18.19@2x" style="zoom:70%;" />

查看SQL Server固定服务器角色

<img src="./5.SQL_安全性定义和完整性定义.assets/CleanShot 2024-06-09 at 06.19.27@2x.png" alt="CleanShot 2024-06-09 at 06.19.27@2x" style="zoom:50%;" />

添加登录名到固定服务器角色：SP_addsrvrolemember

sp_addsrvrolemember 'sweetHeart', 'sysadmin'

添加用户名到数据库角色：SP_addrolemember

sp_addrolemember 'db_datawriter', 'Carefully'

### 利用当前用户实现行级精细存取控制

普通员工只能查看自己的记录

部门经理可以查看他所管理的员工

人力资源代表可以查看所有员工

<img src="./5.SQL_安全性定义和完整性定义.assets/CleanShot 2024-06-09 at 06.21.55@2x.png" alt="CleanShot 2024-06-09 at 06.21.55@2x" style="zoom:50%;" />

<img src="./5.SQL_安全性定义和完整性定义.assets/CleanShot 2024-06-09 at 06.22.02@2x.png" alt="CleanShot 2024-06-09 at 06.22.02@2x" style="zoom:50%;" />

授权Tom只有察看职工平均工资的权限

<img src="./5.SQL_安全性定义和完整性定义.assets/CleanShot 2024-06-09 at 06.22.36@2x.png" alt="CleanShot 2024-06-09 at 06.22.36@2x" style="zoom:50%;" />

自主访问控制（DAC）

* 对客体拥有控制权的主体能够将对该客体的访问权自主地授予其它主体，并在随后任何时刻将这些权限回收

强制访问控制（MAC）

* 敏感度标记：绝密、机密、可信、公开
* 主体：许可证级别；客体：密级

保密性规则

* 下读：仅当主体许可证级别高于或等于客体密级时才能读取相应容体
* 上写：仅当主体许可证级别低于或等于客体密级时体才能写相应客体

### 统计数据库安全性

要求：用户只能查询数据的聚集值，不能访问个体

漏洞一：个体太少

* 查询选修“古典哲学史”的学生的平均成绩

漏洞二：多次查询，太多交叠

* Q1：查询n个学生的总成绩为x
* Q2：查询n个学生+A的总成绩为Y，推出 A的总成绩为Y-X

<img src="./5.SQL_安全性定义和完整性定义.assets/CleanShot 2024-06-09 at 06.24.47@2x.png" alt="CleanShot 2024-06-09 at 06.24.47@2x" style="zoom:50%;" />

Student(ID, GPA), ID从1到50

* 要求任何查询结果只能是一个聚集值，每次至少使用4条元组，任何两个查询的交不能大于2条元组。给出一个查询集合，使得能确定ID=9的GPA

## 完整性定义

### 约束的对象级别

列级约束

* 列值范围

行级约束

* 同一行各列之问

表级约束

* 行间、表上、表间

分析下面约束的对象级别

1. **Sno要求是8位整数，首位是0或1**：
   - 这是一个列级约束，因为它限制了单个列的取值范围。具体来说，它对某一列（例如学生编号Sno）的值进行了格式上的限制。

2. **飞行员的星级评定取决于其飞行里程**：
   - 这是一个行级约束，因为它涉及同一行中不同列之间的关系。飞行员的星级评定是根据飞行里程来确定的，属于同一行中的两个不同属性之间的约束。

3. **选课人数不能少于10人，多于100人**：
   - 这是一个表级约束，因为它对整个表的行数进行了限制。选课人数是一个全局约束，影响表中的所有记录。

4. **在本地纳税记录超过5年才有购房资格**：
   - 这是一个表间约束，因为它涉及两个不同表（纳税记录表和购房资格表）之间的关系。要满足这个约束，需要检查某人在纳税记录表中的连续纳税年限是否超过5年，然后才能在购房资格表中进行相应的操作。

### 约束类型

primary key
foreign key
unique
default
not null
check

这些约束的对象级别分别是什么？

1. **Primary Key (主键)**：
   - **表级约束**：主键约束通常用于唯一标识表中的每一行记录。虽然主键可以在列级定义（单列主键），但它实际上是一个表级约束，因为它确保表中每一行的主键值是唯一的。

2. **Foreign Key (外键)**：
   - **表级约束**：外键约束用于确保表与表之间的关系。它引用另一个表的主键或唯一键，确保数据的参照完整性。因此，外键约束是表级约束。

3. **Unique (唯一约束)**：
   - **列级约束或表级约束**：唯一约束可以确保单个列或多个列的组合值在表中是唯一的。如果是单列唯一约束，可以被视为列级约束；如果是多列组合唯一约束，则是表级约束。

4. **Default (默认值)**：
   - **列级约束**：默认值约束用于指定当插入记录时，某列没有提供值时的默认值。因此，它是一个列级约束。

5. **Not Null (非空)**：
   - **列级约束**：非空约束确保列不能包含NULL值，因此它是一个列级约束。

6. **Check (检查约束)**：
   - **列级约束或表级约束**：检查约束用于确保列中的值满足特定条件。它可以应用于单个列（列级约束）或者多个列（表级约束），具体取决于条件的范围。

### 约束检查

<img src="./5.SQL_安全性定义和完整性定义.assets/CleanShot 2024-06-09 at 06.30.04@2x.png" alt="CleanShot 2024-06-09 at 06.30.04@2x" style="zoom:50%;" />

相互参照的表，如何插入行？

先禁用外键约束，插入数据，然后启用外键约束

<img src="./5.SQL_安全性定义和完整性定义.assets/CleanShot 2024-06-09 at 06.36.04@2x.png" alt="CleanShot 2024-06-09 at 06.36.04@2x" style="zoom:50%;" />



<img src="./5.SQL_安全性定义和完整性定义.assets/CleanShot 2024-06-09 at 06.30.13@2x.png" alt="CleanShot 2024-06-09 at 06.30.13@2x" style="zoom:50%;" />

如何往自参照的表里批量插入数据？

使用延迟约束, 将多个更新操作语句放入一个事务，在提交时才检查约束

<img src="./5.SQL_安全性定义和完整性定义.assets/CleanShot 2024-06-09 at 06.35.56@2x.png" alt="CleanShot 2024-06-09 at 06.35.56@2x" style="zoom:50%;" />
